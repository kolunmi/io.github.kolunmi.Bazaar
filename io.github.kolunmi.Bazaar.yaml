id: io.github.kolunmi.Bazaar
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: bazaar
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  # We need directory access to system flatpak installation
  - --filesystem=/var/lib/flatpak
  # Needs to talk to host so that installing flatpaks work
  - --talk-name=org.freedesktop.Flatpak
  # Can't read flatpaks from the system without this
  - --system-talk-name=org.freedesktop.Flatpak.SystemHelper
  # Necessary so that appstream/libflatpak can read remote content, seems to entirely fail without this access
  - --filesystem=/var/tmp
  # We need to be able to clean up application data
  - --filesystem=~/.var/app
  # Not having this makes it so libflatpak misbehaves and can't detect all flatpaks installed by users properly
  # "(x) flatpaks need to be updated" when they in fact don't
  - --system-talk-name=org.freedesktop.Accounts
cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /share/applications/mimeinfo.cache
  - /share/bash-completion
  - /share/zsh/site-functions
  - /share/icons/hicolor/icon-theme.cache
  - /share/man
  - /share/pkgconfig
  - '*.la'
  - '*.a'

modules:
  - name: bazaar
    buildsystem: meson
    config-opts:
      - -Dsandboxed_libflatpak=true
      # Set this to `etc` so that distributors can override `host-etc` perms
      - -Dhardcoded_main_config_path=/run/host/etc/bazaar/bazaar.yaml
      - -Dhardcoded_content_config_path=/run/host/etc/bazaar/config.yaml
      - -Dhardcoded_blocklist_path=/run/host/etc/bazaar/blocklist.txt
    sources:
      - type: git
        url: https://github.com/kolunmi/bazaar
        commit: 0d86960a0960e85c9e305e181c653d40bce20b3a
        tag: v0.7.0
        x-checker-data:
          type: git
          url-template: $version
          is-main-source: true

    modules:
      - name: md4c
        buildsystem: cmake
        config-opts:
          - -DBUILD_MD2HTML_EXECUTABLE=Off
        sources:
          - type: git
            url: https://github.com/mity/md4c.git
            commit: 729e6b8b320caa96328968ab27d7db2235e4fb47
            tag: release-0.5.2
            x-checker-data:
              type: git
              tag-pattern: ^release-([\d.]+)$

      - name: flatpak
        buildsystem: meson
        config-opts:
          - -Dgtkdoc=disabled
          - -Ddocbook_docs=disabled
          - -Dtests=false
          - -Dman=disabled
          - -Dseccomp=disabled
          - -Dselinux_module=disabled
          - -Dmalcontent=disabled
          - -Dsandboxed_triggers=false
          - -Dsystem_helper=enabled
          - -Dhttp_backend=curl
          - -Dsystemd=disabled
          - -Dsystem_install_dir=/var/lib/flatpak
          - -Dsystem_bubblewrap=bwrap
          - -Dsystem_dbus_proxy=xdg-dbus-proxy
          - --sysconfdir=/var/run/host/etc
        cleanup:
          - /bin/flatpak-bisect
          - /bin/flatpak-coredumpctl
          - /etc/profile.d
          - /lib/systemd
          - /share/dbus-1/interfaces/org.freedesktop.*
          - /share/dbus-1/services/org.freedesktop.*
          - /share/flatpak/triggers
          - /share/gdm
          - /share/zsh
          - /share/fish
          - /lib/sysusers.d
          - /lib/tmpfiles.d
        post-install:
          - install -Dpm0755 -t /app/bin /usr/bin/update-{mime,desktop}-database
        sources:
          - type: git
            url: https://github.com/flatpak/flatpak
            commit: 0835c0272f3a0389f97b02cad4b208f80fec99ed
            tag: 1.17.0
            x-checker-data:
              type: git
              url-template: $version
              is-important: true

        modules:
          - name: python3-pyparsing
            buildsystem: simple
            cleanup:
              - '*'
            build-commands:
              - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST}
                pyparsing
            sources:
              - type: file
                url: https://files.pythonhosted.org/packages/f2/a5/181488fc2b9d093e3972d2a472855aae8a03f000592dbfce716a512b3359/pyparsing-3.2.5.tar.gz
                sha256: 2df8d5b7b2802ef88e8d016a2eb9c7aeaa923529cd251ed0fe4608275d4105b6
                x-checker-data:
                  type: pypi
                  name: pyparsing
              - type: file
                url: https://files.pythonhosted.org/packages/69/59/b6fc2188dfc7ea4f936cd12b49d707f66a1cb7a1d2c16172963534db741b/flit_core-3.12.0.tar.gz
                sha256: 18f63100d6f94385c6ed57a72073443e1a71a4acb4339491615d0f16d6ff01b2
                x-checker-data:
                  type: pypi
                  name: flit_core

          # needed by flatpak system_helper
          - name: polkit
            buildsystem: meson
            config-opts:
              - -Dlibs-only=true
              - -Dintrospection=false
              - -Dauthfw=shadow
            rm-configure: true
            build-options:
              env:
                CFLAGS: -Wno-implicit-function-declaration
            cleanup:
              - /bin/*
              - /etc/dbus-1
              - /etc/pam.d
              - /include
              - /lib/pkgconfig
              - /lib/polkit-1
              - /share/dbus-1/system-services/*
              - /share/polkit-1
            sources:
              - type: git
                url: https://github.com/polkit-org/polkit
                commit: d627b0d1e1108563658dabe3fb8d2a065e64df10
                tag: '126'
                x-checker-data:
                  type: git
                  tag-pattern: ^([\d.]+)$

            modules:
              - name: ostree
                build-options:
                  env:
                    BASH_COMPLETIONSDIR: /app/share/bash-completion/completions
                  config-opts:
                    - --disable-man
                    - --with-curl
                    - --without-libsystemd
                cleanup:
                  - /bin
                  - /etc/grub.d
                  - /etc/ostree
                  - /share/ostree
                  - /libexec
                sources:
                  - type: git
                    url: https://github.com/ostreedev/ostree
                    tag: v2025.7
                    commit: 134d144cb52ff018cfedfb936b661189bccc76e6
                    x-checker-data:
                      type: anitya
                      project-id: 10899
                      tag-template: v$version
                      is-important: true

                modules:
                  - name: libfuse
                    build-options:
                      env:
                        MOUNT_FUSE_PATH: ../tmp/
                    config-opts:
                      - UDEV_RULES_PATH=/app/etc/udev/rules.d
                      - INIT_D_PATH=/app/etc/init.d
                    cleanup:
                      - /bin/ulockmgr_server
                      - /etc
                    post-install:
                      - install -Dpm0755 ./fusermount-wrapper.sh /app/bin/fusermount
                    sources:
                      - type: archive
                        url: https://github.com/libfuse/libfuse/releases/download/fuse-2.9.9/fuse-2.9.9.tar.gz
                        sha256: d0e69d5d608cc22ff4843791ad097f554dd32540ddc9bed7638cc6fea7c1b4b5
                      - type: patch
                        path: fuse-2.9.2-namespace-conflict-fix.patch
                      - type: patch
                        path: fuse-disable-sys-mount-under-flatpak.patch
                      - type: patch
                        path: fuse-2.9.2-closefrom.patch
                      - type: file
                        path: fusermount-wrapper.sh

              - name: xdg-dbus-proxy
                buildsystem: meson
                config-opts:
                  - -Dman=disabled
                  - -Dtests=false
                sources:
                  - type: git
                    url: https://github.com/flatpak/xdg-dbus-proxy
                    commit: 1c1989e56f94b9eb3b7567f8a6e8a0aa16cba496
                    tag: 0.1.6
                    x-checker-data:
                      type: git
                      url-template: $version

  - name: bubblewrap
    buildsystem: meson
    config-opts:
      - -Dman=disabled
      - -Dselinux=disabled
      - -Dtests=false
    sources:
      - type: git
        url: https://github.com/containers/bubblewrap
        commit: 9ca3b05ec787acfb4b17bed37db5719fa777834f
        tag: v0.11.0
        x-checker-data:
          type: git
          url-template: $version
